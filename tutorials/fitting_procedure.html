

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>What’s fit.py doing? The fitting procedure in detail &mdash; frank 1.2.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=590429e0"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Testing a fit’s sensitivity to the hyperparameters \(\alpha\) and \(w_{\rm smooth}\)" href="prior_sensitivity.html" />
    <link rel="prev" title="Generating a UVTable from an MSTable for input to frank" href="mstable_to_uvtable.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            frank
              <img src="../_static/prom_photo.jpg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.2.3
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Using the code</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install.html"> Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html"> Quickstart</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html"> Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="mstable_to_uvtable.html">Generating a UVTable from an MSTable for input to <code class="docutils literal notranslate"><span class="pre">frank</span></code></a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">What’s fit.py doing? The fitting procedure in detail</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#1.-Read-in-the-parameter-values-and-data">1. Read in the parameter values and data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#2.-Determinine-the-disc-geometry-and-deproject-the-visibilities">2. Determinine the disc geometry and deproject the visibilities</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#2.1-Adding-your-own-geometry-fit-routine">2.1 Adding your own geometry fit routine</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#3.-Fit-the-deprojected-visibilities-for-the-brightness-profile">3. Fit the deprojected visibilities for the brightness profile</a></li>
<li class="toctree-l3"><a class="reference internal" href="#4.-Save-the-results-and-generate-plots">4. Save the results and generate plots</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="prior_sensitivity.html">Testing a fit’s sensitivity to the hyperparameters <span class="math notranslate nohighlight">\(\alpha\)</span> and <span class="math notranslate nohighlight">\(w_{\rm smooth}\)</span></a></li>
<li class="toctree-l2"><a class="reference internal" href="fit_convergence.html">Testing a fit’s convergence</a></li>
<li class="toctree-l2"><a class="reference internal" href="model_limitations.html">Examining the model’s limitations</a></li>
<li class="toctree-l2"><a class="reference internal" href="lognormal_fit.html">Fitting a <code class="docutils literal notranslate"><span class="pre">frank</span></code> model in logarithmic brightness</a></li>
<li class="toctree-l2"><a class="reference internal" href="mock_data.html">Taking a Hankel transform, and generating mock data with <code class="docutils literal notranslate"><span class="pre">frank</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://ui.adsabs.harvard.edu/search/q=citations(doi%3A10.1093%2Fmnras%2Fstaa1365)%20&amp;sort=date%20desc%2C%20bibcode%20desc&amp;p_=0"> Papers citing frank</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Under the hood</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../py_API.html"> API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../genindex.html"> Index</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/discsim/frank/blob/master/HISTORY.rst"> Changelog</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/discsim/frank"> Github</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/discsim/frank/issues"> Submit an issue</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">frank</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">What’s fit.py doing? The fitting procedure in detail</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="admonition note">
<p class="admonition-title">Note</p>
<p>This tutorial is produced by the Jupyter notebook <a class="reference external" href="https://github.com/discsim/frank/blob/master/docs/tutorials/fitting_procedure.ipynb">here</a>.</p>
</div>
<section id="What's-fit.py-doing?-The-fitting-procedure-in-detail">
<h1>What’s fit.py doing? The fitting procedure in detail<a class="headerlink" href="#What's-fit.py-doing?-The-fitting-procedure-in-detail" title="Link to this heading"></a></h1>
<p>To give further insight into the fitting process in Frankenstein (<code class="docutils literal notranslate"><span class="pre">frank</span></code>) and how you can modify it, here we’ll use the code as a module and perform the same fit that’s in the <a class="reference internal" href="../quickstart.html"><span class="doc">Quickstart</span></a>, just in more detail.</p>
<p>So we’ll keep using the DSHARP continuum observations of AS 209 (<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2018ApJ...869L..41A/abstract">Andrews et al. 2018</a>) as the input dataset, and frank will reconstruct the disc’s 1D radial brightness profile by nonparametrically fitting the real component of the visibility distribution.</p>
<p>Specifically frank will perform 4 steps in the fit, which we’ll break into distinct calls here (these are the steps taken in <code class="docutils literal notranslate"><span class="pre">fit.py</span></code>):</p>
<ol class="arabic simple">
<li><p>Parse the <em>.json</em> parameter file and read in the data (UVTable);</p></li>
<li><p>Determine the disc geometry (inclination, position angle and phase offset), then deproject the visibilities;</p></li>
<li><p>Fit the deprojected visibilities with a Gaussian process (it’ll take ~50 sec for this dataset) to yield a brightness profile;</p></li>
<li><p>Save the fit results and diagnostic figures. We’ll also supply a CLEAN brightness profile for the disc as well as the synthesized CLEAN beam parameters, in order to compare the frank fit to the CLEAN fit by:</p>
<ul class="simple">
<li><p>Convolving the fitted frank brightness profile with the synthesized beam to compare to the CLEAN profile and</p></li>
<li><p>Taking the discrete Hankel transform of the CLEAN profile to compare to the frank visibility domain fit.</p></li>
</ul>
</li>
</ol>
<p>Let’s walk through these.</p>
<section id="1.-Read-in-the-parameter-values-and-data">
<h2>1. Read in the parameter values and data<a class="headerlink" href="#1.-Read-in-the-parameter-values-and-data" title="Link to this heading"></a></h2>
<p>As in the second example in the <a class="reference internal" href="../quickstart.html"><span class="doc">Quickstart</span></a> - where we use frank as a module - we’ll import the internal classes <a class="reference internal" href="../py_API.html#frank.radial_fitters.FrankFitter"><span class="std std-ref">FrankFitter</span></a> and <a class="reference internal" href="../py_API.html#frank.geometry.FitGeometryGaussian"><span class="std std-ref">FitGeometryGaussian</span></a> directly, in order to demonstrate their usage. Just note that <code class="docutils literal notranslate"><span class="pre">fit.py</span></code> uses the wrapper functions <code class="docutils literal notranslate"><span class="pre">deproject_disc</span></code> and <code class="docutils literal notranslate"><span class="pre">perform_fit</span></code> to call these, and more generally uses wrapper functions to do everything that
we’ll walk through more verbosely here.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">frank</span>
<span class="kn">from</span> <span class="nn">frank.geometry</span> <span class="kn">import</span> <span class="n">FitGeometryGaussian</span><span class="p">,</span> <span class="n">FixedGeometry</span>
<span class="kn">from</span> <span class="nn">frank.radial_fitters</span> <span class="kn">import</span> <span class="n">FrankFitter</span>
<span class="kn">from</span> <span class="nn">frank.fit</span> <span class="kn">import</span> <span class="n">load_default_parameters</span>
<span class="kn">from</span> <span class="nn">frank.utilities</span> <span class="kn">import</span> <span class="n">convolve_profile</span>
<span class="kn">from</span> <span class="nn">frank.make_figs</span> <span class="kn">import</span> <span class="n">make_deprojection_fig</span><span class="p">,</span> <span class="n">make_clean_comparison_fig</span>

<span class="n">frank</span><span class="o">.</span><span class="n">enable_logging</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Using a UVTable extracted from an MSTable (see <a class="reference internal" href="mstable_to_uvtable.html"><span class="doc">this tutorial</span></a> for how to do this) and the default parameter file <code class="docutils literal notranslate"><span class="pre">default_parameters.json</span></code>, let’s read both in.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">load_default_parameters</span><span class="p">()</span>

<span class="n">as209_dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;AS209_continuum.npz&#39;</span><span class="p">)</span>
<span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">as209_dat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;weights&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</section>
<section id="2.-Determinine-the-disc-geometry-and-deproject-the-visibilities">
<h2>2. Determinine the disc geometry and deproject the visibilities<a class="headerlink" href="#2.-Determinine-the-disc-geometry-and-deproject-the-visibilities" title="Link to this heading"></a></h2>
<p>Before fitting the radial brightness profile, we need to determine the disc’s geometry (inclination, position angle and phase center) in order to deproject the visibilities (recall that frank, fitting in 1D, assumes an axisymmetric source). To do this we pass an object specifying how the geometry is determined to the <a class="reference internal" href="../py_API.html#frank.radial_fitters.FrankFitter"><span class="std std-ref">FrankFitter</span></a> class. <strong>The position angle (PA) is defined positive east of north, and the right ascension offset (dRA) is defined
positive for offsets toward east.</strong></p>
<p>frank has three classes for this: <a class="reference internal" href="../py_API.html#frank.geometry.FixedGeometry"><span class="std std-ref">FixedGeometry</span></a> just takes a geometry you provide, <a class="reference internal" href="../py_API.html#frank.geometry.FitGeometryGaussian"><span class="std std-ref">FitGeometryGaussian</span></a> determines the geometry by fitting a 2D Gaussian directly to the visibilities, and <a class="reference internal" href="../py_API.html#frank.geometry.FitGeometryFourierBessel"><span class="std std-ref">FitGeometryFourierBessel</span></a> determines the geometry by fitting a nonparametric form.</p>
<p><code class="docutils literal notranslate"><span class="pre">FitGeometryFourierBessel</span></code> is a more robust approach than <code class="docutils literal notranslate"><span class="pre">FitGeometryGaussian</span></code>, as the former fits for the geometry without making any assumptions about the functional form of the visibilities. <strong>Note that as ``FitGeometryGaussian`` fits a 2D Gaussian to the visibilities to determine the geometry, it is not a good choice for a highly non-Gaussian disc (like a disc with an inner cavity).</strong> There is a tradeoff in speed for using <code class="docutils literal notranslate"><span class="pre">FitGeometryFourierBessel</span></code>; even for large datasets (of order
<span class="math notranslate nohighlight">\(10^7\)</span> visibilities), <code class="docutils literal notranslate"><span class="pre">FitGeometryGaussian</span></code> takes only <span class="math notranslate nohighlight">\(\approx 30\)</span> sec, while <code class="docutils literal notranslate"><span class="pre">FitGeometryFourierBessel</span></code> takes <span class="math notranslate nohighlight">\(&gt; 10\)</span> min. It’s also useful to determine the geometry in the image plane and compare to the result from <code class="docutils literal notranslate"><span class="pre">frank</span></code>. You can also supply your own geometry fitting routine (see Sec.2.1 below).</p>
<p>For <code class="docutils literal notranslate"><span class="pre">FitGeometryGaussian</span></code> and <code class="docutils literal notranslate"><span class="pre">FitGeometryFourierBessel</span></code> you can choose to provide a known phase center if you <em>just</em> want to fit for the inclination and PA (if running frank from the terminal, set <code class="docutils literal notranslate"><span class="pre">geometry</span> <span class="pre">:</span> <span class="pre">fit_phase_offset</span></code> to <code class="docutils literal notranslate"><span class="pre">false</span></code> in your parameter file and specify <code class="docutils literal notranslate"><span class="pre">dra</span></code> and <code class="docutils literal notranslate"><span class="pre">ddec</span></code> there). You can conversely supply the phase center and just fit for inclination and PA.</p>
<p>You can also supply an initial guess for the source geometry; if running frank from the terminal, setting <code class="docutils literal notranslate"><span class="pre">geometry</span> <span class="pre">:</span> <span class="pre">initial_guess</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code> in your parameter file will use the <code class="docutils literal notranslate"><span class="pre">inc</span></code>, <code class="docutils literal notranslate"><span class="pre">pa</span></code>, and optionally <code class="docutils literal notranslate"><span class="pre">dra</span></code> and <code class="docutils literal notranslate"><span class="pre">ddec</span></code> in that file as the initial guess for the geometry solver. Below we’lls assume we don’t know or have a guess on any of the disc’s geometry parameters, and so fit for them all.</p>
<p><strong>Note that, by default, the visibility deprojection in frank scales the total flux assuming that the disk is optically thick everywhere. Since an inclined optically thick disk covers less area on the sky, the total brightness should be lower by a factor</strong> <span class="math notranslate nohighlight">\(\cos(i)\)</span>. We can see this by considering the solution to the radiative transfer equation for a razor-thin disk (as is assumed in <code class="docutils literal notranslate"><span class="pre">frank</span></code>), <span class="math notranslate nohighlight">\(I(r) = e^{-\tau(r)\ /\ \cos(i)}\)</span>. For a face-on disk, <span class="math notranslate nohighlight">\(i = 0\)</span> and the brightness
at all radii scales inversely with the optical depth <span class="math notranslate nohighlight">\(\tau\)</span>, as expected. Conversely, in the limit that the disk becomes edge-on (<span class="math notranslate nohighlight">\(i \rightarrow 90^\circ\)</span>), the brightness tends toward <span class="math notranslate nohighlight">\(0\)</span>.</p>
<p>Internally in <code class="docutils literal notranslate"><span class="pre">frank</span></code>, this correction is done by scaling the observed visibility amplitudes by a factor <span class="math notranslate nohighlight">\(1 / \cos(i)\)</span> and their weights by <span class="math notranslate nohighlight">\(\cos(i)^2\)</span>. When using <code class="docutils literal notranslate"><span class="pre">frank</span></code> to compute the visibilites for the model (the ‘predicted visibilities’), this scaling will automatically be applied to the model visibilties so that their amplitude matches the observed visibilities. This option is the default because it produces an intensity profile that is consistent with one extracted
directly from a 2D image (such as an azimuthal average or major- or minor- axis cut). If you instead wish to not rescale the visibilities, as appropriate for an optically thin disk, set <code class="docutils literal notranslate"><span class="pre">geometry</span> <span class="pre">:</span> <span class="pre">rescale_flux</span></code> to <code class="docutils literal notranslate"><span class="pre">false</span></code> in your parameter file.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">geom</span> <span class="o">=</span> <span class="n">FitGeometryGaussian</span><span class="p">()</span>
<span class="n">geom</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fitted geometry: inc  = </span><span class="si">{:.2f}</span><span class="s1"> deg,</span><span class="se">\n\t\t</span><span class="s1"> PA   = </span><span class="si">{:.2f}</span><span class="s1"> deg,</span><span class="se">\n\t\t</span><span class="s1">&#39;</span>
      <span class="s1">&#39; dRA  = </span><span class="si">{:.2e}</span><span class="s1"> mas,</span><span class="se">\n\t\t</span><span class="s1"> dDec = </span><span class="si">{:.2e}</span><span class="s1"> mas&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">inc</span><span class="p">,</span> <span class="n">geom</span><span class="o">.</span><span class="n">PA</span><span class="p">,</span>
                                                           <span class="n">geom</span><span class="o">.</span><span class="n">dRA</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span>
                                                           <span class="n">geom</span><span class="o">.</span><span class="n">dDec</span><span class="o">*</span><span class="mf">1e3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
    Fitting Gaussian to determine geometry
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Fitted geometry: inc  = 33.93 deg,
                 PA   = 86.47 deg,
                 dRA  = -8.63e-01 mas,
                 dDec = 2.29e-01 mas
</pre></div></div>
</div>
<div class="line-block">
<div class="line">The published values (<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2018ApJ...869L..42H/abstract">Huang et al. 2018</a>) are a bit different:</div>
<div class="line">      inc = 34.97 deg,</div>
<div class="line">      PA = 85.76 deg,</div>
<div class="line">      dRA = 1.90 mas,</div>
<div class="line">      dDec = 2.50 mas</div>
</div>
<p>So let’s use those.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">geom</span> <span class="o">=</span> <span class="n">FixedGeometry</span><span class="p">(</span><span class="mf">34.97</span><span class="p">,</span> <span class="mf">85.76</span><span class="p">,</span> <span class="mf">1.9e-3</span><span class="p">,</span> <span class="mf">2.5e-3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Using the published geometry, we’ll plot the deprojected (u, v) coordinates and visibilities - unbinned - just to see roughly how much the correction is affecting the (u,v) coordinates and visibility amplitudes. Note that <code class="docutils literal notranslate"><span class="pre">FrankFitter</span></code> (which we’ll use below) deprojects the visibilities as a step in the fit; this figure will just redundantly deproject them (using <code class="docutils literal notranslate"><span class="pre">geom.apply_correction</span></code>) to make the plot.</p>
<p>If running frank from the terminal, you can produce this figure by setting <code class="docutils literal notranslate"><span class="pre">deprojec_plot</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code> in your parameter file.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">make_deprojection_fig</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">bin_widths</span><span class="o">=</span><span class="p">[],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">14</span><span class="p">),</span> <span class="n">force_style</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
    Making deprojection figure
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_fitting_procedure_13_1.png" src="../_images/tutorials_fitting_procedure_13_1.png" />
</div>
</div>
<section id="2.1-Adding-your-own-geometry-fit-routine">
<h3>2.1 Adding your own geometry fit routine<a class="headerlink" href="#2.1-Adding-your-own-geometry-fit-routine" title="Link to this heading"></a></h3>
<p>You can extend frank’s geometry fitting capabilities with your own routines by writing a class that inherits from the <a class="reference internal" href="../py_API.html#frank.geometry.SourceGeometry"><span class="std std-ref">SourceGeometry</span></a> base class. This base class provides the interface used by frank to deproject the visibilities, but you do need to implement your own <a class="reference internal" href="../py_API.html#frank.geometry.SourceGeometry.fit"><span class="std std-ref">fit()</span></a> method. This method will be called internally by <code class="docutils literal notranslate"><span class="pre">FrankFitter</span></code> to determine the geometry.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">fit()</span></code> method should set the attributes <code class="docutils literal notranslate"><span class="pre">_inc</span></code>, <code class="docutils literal notranslate"><span class="pre">_PA</span></code>, <code class="docutils literal notranslate"><span class="pre">_dRA</span></code>, and <code class="docutils literal notranslate"><span class="pre">_dDec</span></code> – in respective units of [deg], [deg], [arcsec], [arcsec] – that are used by the <a class="reference internal" href="../py_API.html#frank.geometry.SourceGeometry.apply_correction"><span class="std std-ref">apply_correction()</span></a>, <a class="reference internal" href="../py_API.html#frank.geometry.SourceGeometry.undo_correction"><span class="std std-ref">undo_correction()</span></a>, <a class="reference internal" href="../py_API.html#frank.geometry.SourceGeometry.deproject"><span class="std std-ref">deproject()</span></a>, and <a class="reference internal" href="../py_API.html#frank.geometry.SourceGeometry.reproject"><span class="std std-ref">reproject()</span></a>
methods.</p>
</section>
</section>
<section id="3.-Fit-the-deprojected-visibilities-for-the-brightness-profile">
<h2>3. Fit the deprojected visibilities for the brightness profile<a class="headerlink" href="#3.-Fit-the-deprojected-visibilities-for-the-brightness-profile" title="Link to this heading"></a></h2>
<p>Now that we have the deprojected visibilities, let’s fit them.</p>
<p>Objects used to perform a fit are in the <code class="docutils literal notranslate"><span class="pre">FrankFitter</span></code> class. In addition to the the <code class="docutils literal notranslate"><span class="pre">geom</span></code> object detailed in Sec.2, five hyperparameters affect the fit: <code class="docutils literal notranslate"><span class="pre">Rmax</span></code> and <code class="docutils literal notranslate"><span class="pre">N</span></code>, which set the disc radius out to which the fit is performed and the number of collocation points used in the fit; and <code class="docutils literal notranslate"><span class="pre">alpha</span></code>, <code class="docutils literal notranslate"><span class="pre">p_0</span></code> and <code class="docutils literal notranslate"><span class="pre">weights_smooth</span></code>, the hyperprior parameters on the power spectrum prior. See the frank methods paper for an explanation and interpretation of these five hyperparameters, and
<a class="reference internal" href="prior_sensitivity.html"><span class="doc">this tutorial</span></a> for a demonstration of how to test their effect on a given fit.</p>
<p>frank performs a fit with the <code class="docutils literal notranslate"><span class="pre">FrankFitter</span></code> class’ <a class="reference internal" href="../py_API.html#frank.radial_fitters.FrankFitter.fit"><span class="std std-ref">fit()</span></a> function. Let’s use this with the <code class="docutils literal notranslate"><span class="pre">geom</span></code> object we generated above using the published geometry values, <code class="docutils literal notranslate"><span class="pre">Rmax</span> <span class="pre">=</span> <span class="pre">1.6&quot;</span></code> appropriate for AS 209, <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">=</span> <span class="pre">250</span></code> to ensure we resolve narrow features in the brightness profile, and the default values <code class="docutils literal notranslate"><span class="pre">p_0</span> <span class="pre">=</span> <span class="pre">1e-15</span></code> Jy<span class="math notranslate nohighlight">\(^2\)</span>, <code class="docutils literal notranslate"><span class="pre">alpha</span> <span class="pre">=</span> <span class="pre">1.05</span></code> and <code class="docutils literal notranslate"><span class="pre">weights_smooth</span> <span class="pre">=</span> <span class="pre">1e-4</span></code>. Recall that we’ll only fit the real component of the
visibilities, as frank is assuming an axisymmetric source that has zero imaginary component.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Rmax</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">weights_smooth</span> <span class="o">=</span> <span class="mf">1.6</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">1e-4</span>

<span class="c1"># Initialze the FrankFitter class</span>
<span class="n">FF</span> <span class="o">=</span> <span class="n">FrankFitter</span><span class="p">(</span><span class="n">Rmax</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geom</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">weights_smooth</span><span class="o">=</span><span class="n">weights_smooth</span><span class="p">)</span>

<span class="c1"># Fit the data, returning the maximum a posteriori solution object</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">FF</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
  Fitting for brightness profile using FrankFitter
    Building visibility matrices M and j
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
    FrankFitter iteration 692
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
    Convergence criterion met at iteration 692
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<p>Once the fit is complete, the brightness profile’s best fit parameters are returned and stored in the <code class="docutils literal notranslate"><span class="pre">FrankFitter</span></code> class’ <a class="reference internal" href="../py_API.html#frank.radial_fitters.FrankFitter.MAP_solution"><span class="std std-ref">MAP_solution</span></a> object (we called it <code class="docutils literal notranslate"><span class="pre">sol</span></code> above). This provides:</p>
<ul class="simple">
<li><p>the <a class="reference internal" href="../py_API.html#frank.radial_fitters.FrankGaussianFit.MAP"><span class="std std-ref">maximum a posteriori solution</span></a> and posterior <a class="reference internal" href="../py_API.html#frank.radial_fitters.FrankGaussianFit.covariance"><span class="std std-ref">covariance</span></a> for the reconstructed brightness profile;</p></li>
<li><p>the fit’s radius points <a class="reference internal" href="../py_API.html#frank.radial_fitters.FrankGaussianFit.r"><span class="std std-ref">r</span></a> and corresponding frequency points <a class="reference internal" href="../py_API.html#frank.radial_fitters.FrankGaussianFit.q"><span class="std std-ref">q</span></a>;</p></li>
<li><p>methods to compute the best fit model’s visibilities at given (u, v) coordinates in either the sky plane with <a class="reference internal" href="../py_API.html#frank.radial_fitters.FrankGaussianFit.predict"><span class="std std-ref">predict</span></a> or the deprojected plane with <a class="reference internal" href="../py_API.html#frank.radial_fitters.FrankGaussianFit.predict_deprojected"><span class="std std-ref">predict_deprojected</span></a>;</p></li>
<li><p>and a method to evaluate the best fit model’s <a class="reference internal" href="../py_API.html#frank.radial_fitters.FrankGaussianFit.log_likelihood"><span class="std std-ref">log_likelihood</span></a>.</p></li>
</ul>
<p>Additionally the <code class="docutils literal notranslate"><span class="pre">FrankFitter</span></code> object we created (we called it <code class="docutils literal notranslate"><span class="pre">FF</span></code>) contains the power spectrum’s best fit parameters:</p>
<ul class="simple">
<li><p>the maximum a posteriori power spectrum mean (<a class="reference internal" href="../py_API.html#frank.radial_fitters.FrankFitter.MAP_spectrum"><span class="std std-ref">MAP_spectrum</span></a>) and covariance (<a class="reference internal" href="../py_API.html#frank.radial_fitters.FrankFitter.MAP_spectrum_covariance"><span class="std std-ref">MAP_spectrum_covariance</span></a>).</p></li>
</ul>
</section>
<section id="4.-Save-the-results-and-generate-plots">
<h2>4. Save the results and generate plots<a class="headerlink" href="#4.-Save-the-results-and-generate-plots" title="Link to this heading"></a></h2>
<p>We could now save the fit results, including the <code class="docutils literal notranslate"><span class="pre">sol</span></code> object, with <code class="docutils literal notranslate"><span class="pre">save_fit(u,</span> <span class="pre">v,</span> <span class="pre">vis,</span> <span class="pre">weights,</span> <span class="pre">sol,</span> <span class="pre">prefix='AS209_continuum')</span></code>. We could also produce a full diagnostic figure and/or simplified figure of the fit. But since we’ve already done all this in the <a class="reference internal" href="../quickstart.html"><span class="doc">Quickstart</span></a>, let’s instead use the <code class="docutils literal notranslate"><span class="pre">sol</span></code> object to make a figure comparing the frank fitted brightness profile to the published CLEAN image-extracted profile (<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2018ApJ...869L..42H/abstract">Huang et al.
2018</a>).</p>
<p>If running frank from the terminal, you can produce this figure by setting, in your parameter file, <code class="docutils literal notranslate"><span class="pre">compare_profile</span></code> to the path to a file with a CLEAN profile (or any comparison profile) and <code class="docutils literal notranslate"><span class="pre">clean_beam</span></code> to the beam parameters (FWHM along both axes, position angle).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the CLEAN radial profile for AS 209</span>
<span class="n">r_clean</span><span class="p">,</span> <span class="n">I_clean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="s1">&#39;./AS209_clean_profile.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">clean_profile</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;r&#39;</span><span class="p">:</span><span class="n">r_clean</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="n">I_clean</span><span class="p">,</span> <span class="s1">&#39;lo_err&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;hi_err&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>

<span class="c1"># Using the same disc geometry parameters as above (the published values)</span>
<span class="c1"># and the CLEAN beam parameters from CASA (`imhead` of the published .fits file),</span>
<span class="c1"># convolve the frank profile with the CLEAN beam</span>
<span class="c1"># Units: [arcsec], [arcsec], [deg]</span>
<span class="n">clean_beam</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bmaj&#39;</span><span class="p">:</span><span class="mf">0.03883</span><span class="p">,</span> <span class="s1">&#39;bmin&#39;</span><span class="p">:</span><span class="mf">0.03818</span><span class="p">,</span> <span class="s1">&#39;beam_pa&#39;</span><span class="p">:</span><span class="mf">85.82243</span><span class="p">}</span>
<span class="n">mean_convolved</span> <span class="o">=</span> <span class="n">convolve_profile</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">geom</span><span class="o">.</span><span class="n">inc</span><span class="p">,</span> <span class="n">geom</span><span class="o">.</span><span class="n">PA</span><span class="p">,</span> <span class="n">clean_beam</span><span class="p">)</span>

<span class="c1"># For the visibility plot, show the observations in 1 and 50 k\lambda bins</span>
<span class="n">bin_widths</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1e3</span><span class="p">,</span> <span class="mf">5e4</span><span class="p">]</span>

<span class="c1"># And for the 2D representations of the 1D profiles, use a colormap with an arcsinh</span>
<span class="c1"># normalization, including a choice of the arcsinh scale parameter, &#39;asinh_a&#39;</span>
<span class="n">stretch</span> <span class="o">=</span> <span class="s1">&#39;asinh&#39;</span>
<span class="n">asinh_a</span> <span class="o">=</span> <span class="mf">0.02</span>

<span class="c1"># Distance to source [pc] (Andrews et al. 2018), just to show a second x-axis in AU</span>
<span class="n">dist</span> <span class="o">=</span> <span class="mf">121.</span>

<span class="c1"># Zoom in on the lower amplitude visibilities to better see the fit accuracies at long baselines</span>
<span class="n">ylims</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>

<span class="n">make_clean_comparison_fig</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="n">clean_profile</span><span class="p">,</span>
                          <span class="n">bin_widths</span><span class="o">=</span><span class="n">bin_widths</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="n">stretch</span><span class="p">,</span> <span class="n">mean_convolved</span><span class="o">=</span><span class="n">mean_convolved</span><span class="p">,</span>
                          <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">ylims</span><span class="o">=</span><span class="n">ylims</span><span class="p">,</span> <span class="n">force_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">16</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
    Making CLEAN comparison figure
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_fitting_procedure_22_1.png" src="../_images/tutorials_fitting_procedure_22_1.png" />
</div>
</div>
<p><strong>a)</strong> The frank profile, this profile convolved with the CLEAN beam, and the CLEAN profile. The frank profile when convolved with the CLEAN beam is pretty similar to the CLEAN profile, an indication that the unconvolved frank profile is correctly identifying sub-beam structure. The observartions are shown in <span class="math notranslate nohighlight">\(1\)</span> and <span class="math notranslate nohighlight">\(50\)</span> k<span class="math notranslate nohighlight">\(\lambda\)</span> bins.</p>
<p><strong>b)</strong> The binned, observed visibilities, the frank visibility domain fit, and the discrete Hankel transform (DHT) of the CLEAN profile. Relative to the frank fit, the DHT of the CLEAN profile is low beyond <span class="math notranslate nohighlight">\(\approx 1\times 10^6 \lambda\)</span>, primarily because of beam convolution. This is another indication that the frank brightness profile is accurately recovering sub-beam structure.</p>
<p><strong>c)</strong> The unconvolved frank profile swept over <span class="math notranslate nohighlight">\(2 \pi\)</span> to generate a face-on, 2D representation of the 1D profile. Note this <em>is not</em> an image generated by CLEANing the frank fitted visibilities. The colorscale is the same across (c) - (e) for comparison.</p>
<p><strong>d)</strong> The frank profile convolved with the CLEAN beam, then swept over <span class="math notranslate nohighlight">\(2 \pi\)</span>. As expected, the 2D sweep has annular features that are less sharply defined that in (c) because convolving the frank profile effectively degrades its resolution.</p>
<p><strong>e)</strong> The CLEAN profile swept over <span class="math notranslate nohighlight">\(2 \pi\)</span>. This is not the CLEANed observation, just a 2D representation of the CLEAN profile for comparison with (c) - (d).</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mstable_to_uvtable.html" class="btn btn-neutral float-left" title="Generating a UVTable from an MSTable for input to frank" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="prior_sensitivity.html" class="btn btn-neutral float-right" title="Testing a fit’s sensitivity to the hyperparameters \(\alpha\) and \(w_{\rm smooth}\)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2024, R. Booth, J. Jennings, M. Tazzari..
      <span class="lastupdated">Last updated on 2024 Sep 04 at 08:31:20 UTC // Images: Universal Studios, NBCUniversal [Public domain].
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>